<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <title>Oldman Rush</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { background: #000; color: #fff; text-align: center; }
    #unity-container { margin: auto; width: 100%; max-width: 960px; height: 300px; }
    #play-button-container { margin-top: 10px; display: none; }
    #play-button { padding: 12px 24px; font-size: 18px; border-radius: 8px; border: none; background: #007AFF; color: #fff; }
    #loading-msg { margin-top: 40px; }
  </style>
</head>
<body>
  <div id="unity-container">
    <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
  </div>
  <div id="play-button-container">
    <button id="play-button" disabled>Play</button>
  </div>
  <div id="loading-msg">Game wordt voorbereid...</div>

<script>
let telegramReady = false;
let unityReady = false;
let unityInstance = null;
let userData = "";

function checkStartReady() {
    // Activeer de play-knop alleen als Telegram info en Unity klaar zijn
    if (telegramReady && unityReady) {
        document.getElementById("play-button-container").style.display = 'block';
        document.getElementById("play-button").disabled = false;
        document.getElementById("loading-msg").style.display = 'none';
    }
}

// 1. Haal Telegram info op zodra pagina laadt
document.addEventListener("DOMContentLoaded", function () {
    let tg = window.Telegram && window.Telegram.WebApp;
    if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) {
        document.getElementById("loading-msg").innerText = "Open deze game via Telegram!";
        return;
    }

    // Bouw user data string
    let initData = tg.initDataUnsafe;
    userData = [
        initData.user?.id || '',
        initData.user?.username || '',
        initData.chat?.id || '',
        initData.user?.first_name || '',
        initData.user?.last_name || ''
    ].join(';');
    telegramReady = true;
    checkStartReady();

    // 2. Laad Unity loader script pas als Telegram info binnen is!
    var buildUrl = 'Build';
    var loaderUrl = buildUrl + '/oldmanrush.loader.js';
    var config = {
        dataUrl: buildUrl + '/oldmanrush.data',
        frameworkUrl: buildUrl + '/oldmanrush.framework.js',
        codeUrl: buildUrl + '/oldmanrush.wasm',
        streamingAssetsUrl: 'StreamingAssets',
        companyName: 'Highscore Gaming',
        productName: 'Maze',
        productVersion: '0.1',
        showBanner: function(msg, type) { console.log(type + ': ' + msg); }
    };

    var script = document.createElement('script');
    script.src = loaderUrl;
    script.onload = function() {
        createUnityInstance(document.getElementById('unity-canvas'), config).then(function(instance) {
            unityInstance = instance;
            unityReady = true;
            checkStartReady();
        });
    };
    document.body.appendChild(script);
});

// 3. Wanneer gebruiker op Play drukt: stuur data & fullscreen
document.getElementById('play-button').addEventListener('click', function() {
    document.getElementById('unity-container').classList.add('fullscreen');
    document.getElementById('play-button-container').style.display = 'none';
    // Telegram user data naar Unity sturen
    if (unityInstance && userData) {
        unityInstance.SendMessage('TelegramParams', 'SetTelegramUserData', userData);
    }
});
</script>
</body>
</html>
